import copy
from util.Vector2 import Vector2
from util.timer import timer_func
from tqdm import tqdm

layout1 = r""".|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|...."""

layout2 = r"""\\.........../..............-..../....\.......\.................|....|..........|............-\.....|.........
................................../.......|..\..........-....................\........../../\../..............
.............................|...|.............\..\.....|.........\....................../............/-......
\................\.............|..../........\\.....\\........-.........../..\.../...\.......\/.......|..|....
......\..............|...|..../........-../.................../....|./................./.\........\.|-........
.............................-....................-............/.\............../........\/........|...\......
./........|................\.|........\.......\../.-.........\..-.............|...............................
|....................|...............-/............-.|..|...........................|..................\......
................../........\../...........|..................\................./.......\...-......../|........
././...........-..|....................................-.....................|./........../..|.-..\..|.....|..
.............|.......................||................................../..-........./.................../...
........-......\............/.....-...\..|...........\..........-.........................\...................
\/...............\.|......................\......\.........\/..........\................./.-.../...-.....|....
....\........................................................\.......-/.............\/.........\..............
\........\.........\..\..|....\..............-...../.................|.....|.................\.-/.............
.............................\/..-..............\....-...-............................................./......
....|..../...................//.........\.............\......|...|....../............|.......-.|.-.-|.......\.
.........|..-.-........\\../...........|.....\............................../....\\..\......../......\\..|....
.......|....................-...././...../.|../........................./...-\...|.......|.......-....|......\
../.../........-......................|......-.....\..............-../.......|./.......|.............|.......|
........................................................./............-......\.../........\../../.........\...
........................./../.../............-.\.........................|..............|....................|
..-......./.--.......|.............................................\........\.........\...............\......|
.|........................................|..........-....\.......\.......|................................../
..............................................\.....\........|.....\./......\................|......../...../.
./.\......../..\\..|....-.-|..-.............................................../.\|/........\.........-|...|...
........|........-.\/................-.........-............../.|..........\./|...--...............|..........
.................-............./././...........|.|.....|....|......\-....|...............|....................
.......././..............................................|/...\........../......./..||.\..-...................
............-..|....................\..-./.........\..........................................................
./.-...............\......\...|......\....../..........................-....................-...|......\......
.....././...-........................\..../..|-.............../.......................................\|......
-.........................................../...............-....../.....|.........\..-.........|.............
....|.......\....\|.....\.|....|.............\..\...-............../.....................\....-...............
.............-..-..................\..............|..|........................-..........\../.\......../......
.....|.....................\.....\.......\...........\....|.........\.......//.................|........./....
|.....\-/.......|............../.....\..........|......./......./...............\./..........|................
............../|.......................|....../..............-...................-...................../......
../|....\.......\...............\................-........\..../../.................\/.........\....\.........
........-.....|.|......-...........\............|...................\...........|.......................|.....
.....|....|..\..........................|................\..../....-..................................|.......
..-........||/................/........|......................-....-..................../..|...../............
............./.............\..-.......................\..................||.-.-..|...............\...|...\....
............................\....\....../....\...........-...................|....-.....|.....................
.../...........................-..|.....|../.........\./.................\|..............||....|..........\...
.................../........\...........\........../............|...|\....\........|......-...\.......|./...\.
-....|...........\............./..\...........||...................|.............../...............\..........
.........\.........-..................../.../.......//.............-/...-.-|....\.............................
..-.........\......././................-.........|-...../............|....-.............\.....................
......../.......|.............................\....|......................../................................-
..\........./.--................/................................................................../......-...
.../................|.\....-.................................\.../....................................\.......
.............................\....../.|...........-............................................/....-.........
...\./..........-........./../...............................-..-........-....../..................-.....\....
.........\........./\........................-.-................................|.............................
..../.|-.................................-............\..................|.........|......./......-...........
.-|..........................-........|...//..\.../.........-............/|.............|..............-..\...
..../......|...\..........|...........-.||....-..|.........-......../..........|................../...........
\.../../............./../...........\...........\.......................................\./.............|.....
.....|.../....|..............................\........\...................|.........|.........................
..........|............|............./......../.../................................-.....-.........../..|.....
......-.\.........................|...../.....\.....-/....-..|.\.........\|....-.........||...........\.......
..\......\............./...............\-............/...|................................/...................
.......|.|...|.|.........|..|.......-...\.........|./..|..................-................|..........-.......
..-\...--..-........|......................-.....|./..............|/.................../...........\....-.../.
...........-...-........-..........-...........|.......-................\.........|............-.............|
.....|.\..-../....\.................../-....\.............|......../....\/.\..\...//..........|...............
......-.-.|..|............................./.........-....|.......|......|..............................-...-.
..|............\...|................./\...|........../...-.|.........\..../.........|-...|.......\...........-
...................\..../..............|...../.....\....../.................\..|.....................-........
.|............-................../........-.....|..../..........................|../..\.....\....|............
.............................................|..........|......-\.............-..-........................\...
............./.-....|......|................................................-/|/...|../...........-...|.......
......-................-..-...............|................-.-.............\........|...-./................-..
...........|...........-/........../..................../|.|...................|...................../........
.....................................\......................../...........|-...........-................../...
...|.....\.....-...../..............|.........\....\............-\............\/.........................-....
..............-\......-.............../...|.........................................|.....\/..................
.................|...|.....|.............../....\...............-....\..........|.-........|........../...|...
..|...-.........\....-.....\.....................|...|.......-....\....-..-......-.\../........-../...........
.......\.....\................\......\-................................|..\.....//.........../..........\.....
........................../.-.................................\--......../..-.................................
.................|............|\./....|.|..|.............//......./.......................|.....\.....\\......
./...|\...................................../.......................\.........|..............|....|....\......
......|.............................................................\..|.................\-..../......./......
.....-.......|........../......./..\...........|...........-..|......../...../................\......\........
............\....-........\......./.......-...........................................\........-/./...........
|..................................-.........\/..-....././.....\.............../-....................\........
../.........-..........-....-...-.........\/....................../.../.....\............................-.\.|
........../...-..-........................-........................................./....\.....-..............
..|-.\........\....................\.\..........-....|.-.-...........\..............\..-.....|................
..-.../......./\.\...\\.//.....|..........................\........|.-||......................|.......\/......
...-........-/.............................-......................-|....\...|..../..|.........\...............
.........|..|/........./.......\....\../\.-..-...\..|...../...........\.............../..................../\.
.........\.-\|..|../...........--..........|-......|...|.................||...................................
..................\.....\...........................|.............\..|.........................|...........\..
....|../........../.............................|./........\\.....|.....|...................................|.
-..........................................-........................-...\..................\.....\......-.....
..\.\......|......|........|.............-|....-.....-...........|../.-.........|........\..\...-...\........\
.|.......-..|....|..............|.................../...............|.............................-.........//
....................\..\.||./\.......-.........-..-................../..../....................-/..........\..
.........\.........|...-.....\..........\.\....|.|..............|..........................................\.|
...|\..|................-/..........|\....\/|..-...........................................\..................
.../...\.|..............................\.-...\.........\....../../...............-./............/............
.....-.\..............................................\.|....................\..........|...............|.....
.....|................../|....-....-....\..../...............\.....|..|......./.................../........\..
.......................\....................-.......-.................../..............-...\..\........|......
...../................\........../..|.../...........|........|............\........-....-/.....\....|.........
.\\.\............|..................................................|......\/..........................\......
....|........../...../...-.................|......|..........-....................................../.../....."""


class Directions:
    RIGHT = Vector2(1, 0)
    DOWN = Vector2(0, 1)
    LEFT = Vector2(-1, 0)
    UP = Vector2(0, -1)


EMPTY_SPACE = "."
MIRROR_DOWN = "\\"
MIRROR_UP = "/"
VERTICAL_SPLITTER = "|"
HORIZONTAL_SPLITTER = "-"

LIGHT = {
    Directions.UP: "^",
    Directions.DOWN: "v",
    Directions.LEFT: "<",
    Directions.RIGHT: ">",
}

class Grid: 
    def __init__(self, layout: str) -> None:
        self.grid = [list(line) for line in layout.splitlines()]
        self.height = len(self.grid)
        self.width = len(self.grid[0])

    def inbound(self, pos: Vector2):
        return 0 <= pos.x < self.width and 0 <= pos.y < self.height
    
    def __getitem__(self, pos: Vector2):
        return self.grid[pos.y][pos.x]

    def __setitem__(self, pos: Vector2, item):
        self.grid[pos.y][pos.x] = item
    
    def __str__(self) -> str:
        return "\n".join(["".join(line) for line in self.grid])

class BeamMap:
    def __init__(self, grid: Grid) -> None:
        self.energized_tiles = []
        self.beams = []
        self.grid = copy.deepcopy(grid)
    
    def fire_beam(self, start: Vector2, direction: Vector2):
        pos = start
        while self.grid.inbound(pos):

            if pos not in self.energized_tiles:
                self.energized_tiles.append(Vector2(pos.x, pos.y))

            tile = self.grid[pos]
            is_left_right_moving = direction in [Directions.RIGHT, Directions.LEFT]
            is_top_down_moving = direction in [Directions.UP, Directions.DOWN]
            new_direction = None

            if tile == EMPTY_SPACE:
                self.grid[pos] = LIGHT[direction]
            if tile in LIGHT.values():
                if tile == LIGHT[direction]:
                    return
            if tile == MIRROR_DOWN:
                if direction == Directions.RIGHT: new_direction = Directions.DOWN
                if direction == Directions.LEFT: new_direction = Directions.UP
                if direction == Directions.DOWN: new_direction = Directions.RIGHT
                if direction == Directions.UP: new_direction = Directions.LEFT
                self.beams.append((pos + new_direction, new_direction))
                return 
            if tile == MIRROR_UP:
                if direction == Directions.RIGHT: new_direction = Directions.UP
                if direction == Directions.LEFT: new_direction = Directions.DOWN
                if direction == Directions.DOWN: new_direction = Directions.LEFT
                if direction == Directions.UP: new_direction = Directions.RIGHT
                self.beams.append((pos + new_direction, new_direction))
                return
            if tile == VERTICAL_SPLITTER:
                if is_top_down_moving: pass
                if is_left_right_moving:
                    self.beams.append((pos + Directions.DOWN, Directions.DOWN))
                    self.beams.append((pos + Directions.UP, Directions.UP))
                    return
            if tile == HORIZONTAL_SPLITTER:
                if is_left_right_moving: pass
                if is_top_down_moving:
                    self.beams.append((pos + Directions.RIGHT, Directions.RIGHT))
                    self.beams.append((pos + Directions.LEFT, Directions.LEFT))
                    return

            pos += direction
        
    def fill(self, start, direction):
        self.beams.append((start, direction))
        while True:
            start, direction = self.beams.pop()
            self.fire_beam(start, direction)
            
            if len(self.beams) == 0:
                break
    
    def get_energized_tiles(self):
        return len(self.energized_tiles)

def main(input: str, part1 = False):
    grid = Grid(input)
    if part1:
        beam_map = BeamMap(grid)
        beam_map.fill(Vector2(85,0), Directions.DOWN)
        print(beam_map.get_energized_tiles())
    else:
        max_value = 0
        print("start scan horizontal")
        for x in tqdm(range(grid.width)):
            if x in [85]:
                continue
            beam_map = BeamMap(grid)
            beam_map.fill(Vector2(x,0), Directions.DOWN)
            max_value = max(beam_map.get_energized_tiles(), max_value)

            beam_map = BeamMap(grid)
            beam_map.fill(Vector2(x,grid.height-1), Directions.UP)
            max_value = max(beam_map.get_energized_tiles(), max_value)

        print("start scan vertical")
        for y in tqdm(range(grid.height)):
            beam_map = BeamMap(grid)
            beam_map.fill(Vector2(0,y), Directions.RIGHT)
            max_value = max(beam_map.get_energized_tiles(), max_value)

            beam_map = BeamMap(grid)
            beam_map.fill(Vector2(grid.width-1,y), Directions.LEFT)
            max_value = max(beam_map.get_energized_tiles(), max_value)
        print("result:", max_value)



    


main(layout2)

